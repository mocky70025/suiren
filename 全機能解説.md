# すいれん 全機能解説（最新版）

## 📋 システムの全体像

このシステムは、**学校内での転売のための支払い管理システム**です。
- **買い手**：商品を買う人（支払う人）
- **売り手**：商品を売る人（お金を受け取る人）
- **運営**：全体を管理する人

---

## 🎯 ページの種類

### 1. **一般ユーザー用ページ** (`index.html`)
買い手と売り手が使うページ

### 2. **運営用ページ** (`admin.html`)
運営だけが使う管理ページ

---

## 👤 一般ユーザー用ページの機能

### 🔐 ログイン・新規登録

#### 新規登録
- **ユーザー名**：自分の名前を入力
- **パスワード**：パスワードを設定（確認入力も必要）
- **登録ボタン**：クリックして登録完了

#### ログイン
- **ユーザー名**：登録したユーザー名を入力
- **パスワード**：登録したパスワードを入力
- **ログインボタン**：クリックしてログイン

**重要**：ログインしないと、支払い記録やポイントカードの確認ができません。

---

### 💳 ポイントカード機能（買い手・売り手共通）

ログイン後、自動的に表示されます。

#### 累計支払い金額
- 今までに支払った合計金額が大きく表示されます
- 例：「5,000円」

#### 支払い履歴
- 過去の支払い記録が一覧で表示されます
- 表示内容：
  - **金額**：支払った金額
  - **日時**：いつ支払ったか
- まだ支払いがない場合は「まだ支払い履歴がありません」と表示されます

---

### 💰 支払い機能（買い手用）

**使い方**：

1. **支払い金額を入力**
   - 「支払い金額（円）」の欄に金額を入力
   - 例：1000円

2. **「PayPayで支払う」ボタンをクリック**
   - モーダル（ポップアップ）が表示されます
   - 支払い金額が確認できます

3. **「PayPayアプリを開く」リンクをクリック**
   - PayPayアプリが開きます（スマホの場合）
   - アプリで金額を入力して送金を完了してください

4. **「支払い完了」ボタンをクリック**
   - ポイントカードに金額が追加されます
   - 支払い履歴に記録されます
   - 成功メッセージが表示されます

**注意**：
- 実際のPayPay送金は、PayPayアプリで手動で行います
- システムは「支払いを記録する」だけです
- 送金先のPayPay IDは、自分で入力する必要があります

---

### 📝 受け取り記録（売り手用）

売り手が「お金を受け取った」ことを記録する機能です。

**使い方**：

1. **受け取った金額を入力**
   - 「受け取った金額（円）」の欄に金額を入力
   - 例：1000円

2. **買い手のユーザー名を入力**
   - 「買い手のユーザー名」の欄に、誰から受け取ったかを入力
   - 例：田中
   - **重要**：この情報があると、運営が自動的にポイントカードに反映できます

3. **メモを入力（任意）**
   - 商品名など、覚えておきたい情報を入力
   - 例：商品名など

4. **「記録する」ボタンをクリック**
   - 受け取り記録が保存されます
   - 成功メッセージが表示されます

**処理の流れ**：
1. 売り手が受け取り記録を登録
2. 運営が運営ページで未処理の受け取り記録を確認
3. 運営が「反映」ボタンをクリック
4. 買い手のポイントカードに金額が追加される

**重要**：
- 買い手名を入力すると、運営が自動的にポイントカードに反映できます
- 買い手名を入力しないと、運営が手動で買い手を選択する必要があります

---

### 🚪 ログアウト

- 右上の「ログアウト」ボタンをクリック
- ログイン画面に戻ります

---

## 👨‍💼 運営用ページの機能

### 🔐 運営認証

- **パスワード**：運営用のパスワードを入力
- **ログインボタン**：クリックしてログイン
- 一般ユーザーはアクセスできません

---

### 📊 売り手情報表示

売り手の名前を入力すると、その売り手の情報が表示されます。

**使い方**：

1. **売り手のユーザー名を入力**
   - 例：山田

2. **Enterキーを押す、または検索**
   - 売り手の情報が表示されます

**表示される情報**：

#### 累計入金金額
- その売り手が受け取った合計金額
- 例：「10,000円」

#### 取引回数
- 何回取引があったか
- 例：「5回」

#### 取引履歴
- 過去の取引の一覧
- 表示内容：
  - **金額**：受け取った金額
  - **買い手**：誰から受け取ったか
  - **日時**：いつ受け取ったか

---

### ✅ 未処理の受け取り記録

売り手が記録した「受け取り記録」を確認して、ポイントカードに反映する機能です。

**表示される情報**：
- **金額**：受け取った金額
- **売り手**：誰が受け取ったか
- **買い手**：誰から受け取ったか（売り手が入力した場合）
- **日時**：いつ記録されたか
- **メモ**：追加情報（あれば）

**処理方法**：

#### パターン1：買い手情報が含まれている場合
- 「反映」ボタンが1つだけ表示されます
- クリックするだけで、自動的に買い手のポイントカードに反映されます

#### パターン2：買い手情報がない場合
- ドロップダウンから買い手を選択
- 「反映」ボタンをクリック
- 買い手のポイントカードに反映されます

**処理後**：
- 買い手のポイントカードに金額が追加されます
- 受け取り記録が「処理済み」になります
- 成功メッセージが表示されます

---

### 📋 全データ一覧

すべての記録を見る機能です。

#### 受け取り記録（全件）タブ
- すべての受け取り記録が表示されます
- 処理済み・未処理の両方が表示されます
- 表示内容：
  - **金額**：受け取った金額
  - **売り手**：誰が受け取ったか
  - **買い手**：誰から受け取ったか
  - **日時**：いつ記録されたか
  - **メモ**：追加情報（あれば）
  - **ステータス**：未処理/処理済み

#### 支払い記録（全件）タブ
- すべての支払い記録が表示されます
- 表示内容：
  - **金額**：支払った金額
  - **買い手**：誰が支払ったか
  - **売り手**：誰に支払ったか（あれば）
  - **日時**：いつ支払ったか

**使い方**：
- タブをクリックして切り替えます
- 「受け取り記録（全件）」タブ：すべての受け取り記録
- 「支払い記録（全件）」タブ：すべての支払い記録

---

### 🚪 ログアウト

- 「ログアウト」ボタンをクリック
- 認証画面に戻ります

---

## 🔄 データの流れ（全体の仕組み）

### パターン1：買い手が自分で支払いを記録

```
1. 買い手がログイン
   ↓
2. 支払い金額を入力して「PayPayで支払う」をクリック
   ↓
3. PayPayアプリを開く
   ↓
4. PayPayアプリで実際に送金（手動）
   ↓
5. 「支払い完了」をクリック
   ↓
6. ✅ 自動的にポイントカードに反映
   ↓
7. 支払い記録が保存される
```

**特徴**：
- 即座にポイントカードに反映される
- 売り手情報は記録されない（通常の支払い）

---

### パターン2：売り手が受け取りを記録（夜に運営が確認）

```
1. 売り手がログイン
   ↓
2. 「受け取り記録」で金額・買い手名・メモを入力
   ↓
3. 「記録する」をクリック
   ↓
4. 受け取り記録が「未処理」として保存される
   ↓
5. 運営が運営ページで未処理記録を確認
   ↓
6. 運営が「反映」ボタンをクリック
   ↓
7. ✅ 買い手のポイントカードに反映される
   ↓
8. 受け取り記録が「処理済み」になる
```

**特徴**：
- 売り手が受け取りを記録する
- 運営が確認してからポイントカードに反映
- 買い手名を入力すると、自動的に反映できる

---

## 💡 重要なポイント

### ✅ 自動化されていること

1. **買い手が自分で支払いを記録すると、自動的にポイントカードに反映される**
   - 即座に反映されます
   - 支払い履歴にも記録されます

2. **売り手が受け取り記録に買い手名を入力すると、運営が「反映」をクリックするだけで自動的にポイントカードに反映される**
   - 買い手を手動で選択する必要がありません

### ⚠️ 手動でやること

1. **PayPayアプリでの実際の送金**
   - システムは「支払いを記録する」だけです
   - 実際の送金はPayPayアプリで手動で行います

2. **売り手が受け取り記録を登録**
   - 金額、買い手名、メモを入力

3. **運営が未処理の受け取り記録を確認して「反映」ボタンをクリック**
   - 買い手名が入力されていれば、1クリックで反映できます

### 📱 PayPayについて

- **PayPay APIは使っていない**（個人利用のため認証が取れない）
- **PayPay個人送金**を使っています
  - 「PayPayアプリを開く」リンクでPayPayアプリを開く
  - 実際の送金はPayPayアプリで手動で行う
  - 送金先のPayPay IDは、自分で入力する必要があります
  - 送金完了後、システムで「支払い完了」をクリックして記録

### 🔒 セキュリティ

- パスワードは暗号化（bcrypt）されて保存される
- 運営ページはパスワードで保護されている
- 他人のアカウントに入っても、個人情報は保存されていない（ポイント情報のみ）

---

## 📊 データベースに保存される情報

### users（ユーザー）
- **id**：ユーザーID（自動生成）
- **username**：ユーザー名
- **password**：パスワード（暗号化）
- **paypay_id**：PayPay ID（設定されている場合）
- **created_at**：登録日時

### payments（支払い記録）
- **id**：支払いID（自動生成）
- **user_id**：支払った人のID
- **seller_id**：売り手のID（あれば）
- **amount**：支払い金額
- **created_at**：支払い日時

### seller_receipts（受け取り記録）
- **id**：記録ID（自動生成）
- **seller_id**：売り手のID
- **buyer_id**：買い手のID（あれば）
- **amount**：受け取った金額
- **memo**：メモ
- **status**：ステータス（PENDING：未処理、PROCESSED：処理済み）
- **created_at**：記録日時
- **processed_at**：処理日時（処理済みの場合）

---

## 🎯 使い方の例

### 例1：田中さんが1000円の商品を買う（自分で記録）

**手順**：
1. 田中さんがログイン
2. 支払い金額「1000円」を入力
3. 「PayPayで支払う」をクリック
4. 「PayPayアプリを開く」をクリック
5. PayPayアプリで送金先のPayPay IDを入力して送金
6. 「支払い完了」をクリック
7. ✅ 田中さんのポイントカードに1000円が追加される

---

### 例2：山田さんが田中さんから1000円を受け取る（売り手が記録）

**手順**：
1. 山田さんがログイン
2. 受け取り記録で「1000円」「買い手：田中」を入力
3. 「記録する」をクリック
4. 運営が運営ページで確認
5. 運営が「反映」ボタンをクリック（買い手名が入力されているので自動的に反映）
6. ✅ 田中さんのポイントカードに1000円が追加される

---

### 例3：運営が全データを確認

**手順**：
1. 運営が運営ページにログイン
2. 「全データ一覧」セクションを開く
3. 「受け取り記録（全件）」タブをクリック
   - すべての受け取り記録が表示される
4. 「支払い記録（全件）」タブをクリック
   - すべての支払い記録が表示される

---

## 🚀 まとめ

このシステムは、**学校内での転売の支払いを簡単に管理するためのツール**です。

### 主な機能

1. **ユーザー管理**
   - ログイン・新規登録
   - パスワード保護

2. **ポイントカード機能**
   - 累計支払い金額の表示
   - 支払い履歴の表示

3. **支払い機能**
   - PayPayアプリへの誘導
   - 支払い記録の保存
   - 自動的なポイントカードへの反映

4. **受け取り記録機能（売り手用）**
   - 受け取った金額の記録
   - 買い手情報の記録
   - 運営による確認と反映

5. **運営機能**
   - 売り手情報の確認
   - 未処理の受け取り記録の処理
   - 全データの確認

### データの流れ

- **買い手**：支払いを記録 → 即座にポイントカードに反映
- **売り手**：受け取りを記録 → 運営が確認 → 買い手のポイントカードに反映
- **運営**：全データを確認・管理

すべての支払いが記録され、ポイントカードで累計支払い金額を確認できます！

