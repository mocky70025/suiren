# PayPayスクリーンショット解析機能

## 🎯 機能概要

PayPayアプリの取引履歴（入金・受け取りのみ）のスクリーンショットをアップロードすると、AIが自動的に取引情報を抽出し、LINEユーザーと照合してポイントを付与します。

## 📋 使い方

### 1. PayPayアプリでスクリーンショットを撮影

1. PayPayアプリを開く
2. 「取引履歴」を開く
3. 「絞り込み」→「入金・受け取りのみ」を選択
4. 取引履歴を表示
5. スクリーンショットを撮影

### 2. 運営画面でアップロード

1. 運営画面（`/admin`）にログイン
2. 「ポイントをつける」をクリック
3. 「📷 スクリーンショットを選択」をクリック
4. 撮影したスクリーンショットを選択
5. 「🤖 AIで解析してポイントを付与」をクリック

### 3. 解析結果を確認

- AIが取引情報を抽出します
- LINEユーザー名と照合して、マッチするユーザーを表示します
- 各取引について、ポイントを付与するか選択できます

### 4. ポイントを付与

1. ポイントを付与する取引にチェックを入れる
2. 「選択した取引にポイントを付与」をクリック
3. 確認ダイアログで「OK」をクリック
4. ポイントが付与されます

## ⚙️ 設定

### 必要な環境変数

```
OPENAI_API_KEY=あなたのOpenAI APIキー
```

### OpenAI APIキーの取得方法

1. [OpenAI Platform](https://platform.openai.com/)にアクセス
2. アカウントを作成またはログイン
3. 「API keys」を開く
4. 「Create new secret key」をクリック
5. 生成されたキーをコピー
6. Renderの環境変数に設定

### Renderでの環境変数設定

1. Renderダッシュボードでサービスを選択
2. 「Environment」タブを開く
3. 「Add Environment Variable」をクリック
4. Key: `OPENAI_API_KEY`、Value: あなたのAPIキー
5. 「Save Changes」をクリック

## 🔧 技術詳細

### 使用技術

- **OpenAI Vision API (GPT-4o)**: 画像から取引情報を抽出
- **Multer**: 画像アップロード処理
- **LINEユーザーID照合**: 抽出した送金者名とLINEユーザー名を照合

### 解析プロセス

1. 画像をbase64に変換
2. OpenAI Vision APIに送信
3. AIが取引情報をJSON形式で抽出
4. LINEユーザー名と照合
5. マッチしたユーザーにポイントを付与

### 抽出される情報

- 金額（必須）
- 送金者名（表示されている場合）
- 日時（表示されている場合）
- メモ（表示されている場合）

## ⚠️ 注意事項

1. **精度について**
   - AIの解析精度は画像の品質に依存します
   - スクリーンショットが鮮明で、文字が読みやすいことが重要です
   - マッチしない取引は手動で処理してください

2. **コストについて**
   - OpenAI APIの利用には料金がかかります
   - GPT-4oの画像解析は1回あたり約$0.01〜$0.05程度
   - 使用量に応じてコストが発生します

3. **セキュリティについて**
   - アップロードされた画像は解析後すぐに削除されます
   - 画像には個人情報が含まれる可能性があるため、適切に管理してください

4. **LINEユーザー照合について**
   - 送金者名とLINEユーザー名が完全一致しない場合、マッチしないことがあります
   - 部分一致で照合を試みますが、100%の精度は保証されません

## 💡 トラブルシューティング

### 解析に失敗する場合

- 画像が鮮明か確認してください
- 画像サイズが10MB以下か確認してください
- OpenAI APIキーが正しく設定されているか確認してください

### ユーザーがマッチしない場合

- 送金者名が正しく表示されているか確認してください
- LINEユーザー名と送金者名が一致しているか確認してください
- 手動で処理してください

### ポイントが付与されない場合

- データベースのエラーを確認してください
- サーバーログを確認してください

## 📝 今後の改善案

- 複数画像の一括アップロード
- 解析結果の履歴保存
- より高精度なユーザー照合アルゴリズム
- 解析結果の編集機能

