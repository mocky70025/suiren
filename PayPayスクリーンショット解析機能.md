# PayPayスクリーンショット解析機能

## 🎯 機能概要

PayPayアプリの取引履歴（入金・受け取りのみ）のスクリーンショットをChatGPTで解析し、抽出した情報をシステムに入力してポイントを自動付与します。

**💰 コスト無料！** OpenAI APIは使用せず、ブラウザのChatGPTを使用するため、追加費用はかかりません。

## 📋 使い方

### 1. PayPayアプリでスクリーンショットを撮影

1. PayPayアプリを開く
2. 「取引履歴」を開く
3. 「絞り込み」→「入金・受け取りのみ」を選択
4. 取引履歴を表示
5. スクリーンショットを撮影

### 2. ChatGPTで解析

1. ブラウザで[ChatGPT](https://chat.openai.com/)を開く
2. 撮影したスクリーンショットをアップロード
3. 運営画面に表示されているプロンプトをコピーして送信
4. ChatGPTがJSON形式で取引情報を出力

### 3. 運営画面でポイントを付与

1. 運営画面（`/admin`）にログイン
2. 「ポイントをつける」をクリック
3. ChatGPTが出力したJSONをテキストエリアに貼り付け
4. 「✅ ポイントを付与」をクリック
5. マッチした取引を選択してポイントを付与

## 🔧 プロンプト

運営画面に表示されているプロンプトをコピーして使用してください。プロンプトは以下の形式です：

```
このPayPayの取引履歴（入金・受け取りのみ）のスクリーンショットから、以下のJSON形式で取引情報を抽出してください：

{
  "transactions": [
    {
      "amount": 金額（数値のみ）,
      "sender_name": "送金者の名前（表示されている場合）",
      "date": "日時（表示されている場合）",
      "memo": "メモ（表示されている場合）"
    }
  ]
}

取引が複数ある場合は、すべての取引を配列に含めてください。金額は必ず数値で返してください（例: 1000）。
```

## 📝 JSON形式の例

```json
{
  "transactions": [
    {
      "amount": 1000,
      "sender_name": "田中太郎",
      "date": "2024/01/15 10:30",
      "memo": "商品代金"
    },
    {
      "amount": 500,
      "sender_name": "佐藤花子",
      "date": "2024/01/15 11:00"
    }
  ]
```

## 🔄 処理の流れ

1. **スクリーンショット撮影** → PayPayアプリで取引履歴を表示して撮影
2. **ChatGPTで解析** → スクリーンショットをアップロードしてプロンプトを送信
3. **JSONを取得** → ChatGPTが出力したJSONをコピー
4. **システムに入力** → 運営画面のテキストエリアに貼り付け
5. **ユーザー照合** → 送金者名とLINEユーザー名を自動照合
6. **ポイント付与** → マッチした取引を選択してポイントを付与

## ⚙️ 技術詳細

### 使用技術

- **ChatGPT (ブラウザ版)**: 画像から取引情報を抽出（無料）
- **LINEユーザーID照合**: 抽出した送金者名とLINEユーザー名を照合

### 照合プロセス

1. JSONをパースして取引情報を取得
2. 全LINEユーザーを取得
3. 送金者名とLINEユーザー名を部分一致で照合
4. マッチしたユーザーにポイントを付与

### 抽出される情報

- 金額（必須）
- 送金者名（表示されている場合）
- 日時（表示されている場合）
- メモ（表示されている場合）

## ⚠️ 注意事項

1. **精度について**
   - ChatGPTの解析精度は画像の品質に依存します
   - スクリーンショットが鮮明で、文字が読みやすいことが重要です
   - マッチしない取引は手動で処理してください

2. **ユーザー照合について**
   - 送金者名とLINEユーザー名が完全一致しない場合、マッチしないことがあります
   - 部分一致で照合を試みますが、100%の精度は保証されません
   - マッチしない場合は手動で処理してください

3. **JSON形式について**
   - ChatGPTが出力するJSONが正しい形式であることを確認してください
   - コードブロック（```json）が含まれている場合は自動的に除去されます

## 💡 トラブルシューティング

### JSONが解析できない場合

- JSON形式が正しいか確認してください
- コードブロックが含まれている場合は、手動で除去してください
- ChatGPTに再度プロンプトを送信して、正しい形式で出力されるようにしてください

### ユーザーがマッチしない場合

- 送金者名が正しく表示されているか確認してください
- LINEユーザー名と送金者名が一致しているか確認してください
- 手動で処理してください

### ポイントが付与されない場合

- データベースのエラーを確認してください
- サーバーログを確認してください
- マッチするユーザーが存在するか確認してください

## ✅ メリット

- **💰 コスト無料**: OpenAI APIを使用しないため、追加費用がかかりません
- **🚀 簡単**: ChatGPTのブラウザ版を使用するだけ
- **⚡ 高速**: API呼び出しがないため、処理が高速です
- **🔒 セキュリティ**: 画像をサーバーにアップロードする必要がありません
